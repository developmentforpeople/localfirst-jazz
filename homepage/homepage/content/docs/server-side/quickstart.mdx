export const metadata = {
  description: "Get started building a simple server worker with Jazz."
};

import { CodeGroup, ContentByFramework, FileName, TabbedCodeGroup, TabbedCodeGroupItem } from "@/components/forMdx";
import { Alert } from "@garden-co/design-system/src/components/atoms/Alert";
import { TextLink } from "@garden-co/design-system/src/components/atoms/TextLink";
import { ReactLogo } from "@/components/icons/ReactLogo";
import { SvelteLogo } from "@/components/icons/SvelteLogo";

# Get started with Server Workers in 10 minutes
This quickstart guide will take you from an empty project to a server worker which can interact with your Jazz application. You'll get the most out of this guide if you complete [the frontend quickstart guide](/docs/getting-started/quickstart) first.

<Alert variant="info" className="mt-4 flex gap-2 items-center">
  Requires Node.js 20+.
</Alert>

## Create your Node App

We're going to use Next.js for this guide, but you can use any framework you like.

<TabbedCodeGroup default="pnpm" savedPreferenceKey="package-manager">
<TabbedCodeGroupItem label="npm">
```sh
npx create-next-app@latest --typescript jazz-server-worker
```
</TabbedCodeGroupItem>
<TabbedCodeGroupItem label="pnpm">
```sh
pnpx create-next-app@latest --typescript jazz-server-worker
```
</TabbedCodeGroupItem>
</TabbedCodeGroup>

## Install Jazz

The `jazz-tools` package includes everything you're going to need to build your first Jazz server worker.

<TabbedCodeGroup default="pnpm" savedPreferenceKey="package-manager">
<TabbedCodeGroupItem label="npm">
```sh
npm install jazz-tools
```
</TabbedCodeGroupItem>
<TabbedCodeGroupItem label="pnpm">
```sh
pnpm add jazz-tools
```
</TabbedCodeGroupItem>
</TabbedCodeGroup>

## Get your free API key

Sign up for a free API key at [dashboard.jazz.tools](https://dashboard.jazz.tools) for higher limits or production use, or use your email address as a temporary key to get started quickly.

<FileName>.env</FileName>
<CodeGroup>
```bash
JAZZ_API_KEY=you@example.com
```
</CodeGroup>

## Define your schema
We're going to define a simple schema for our server worker. We'll use the `root` on the worker to store a list of bands. We're also going to add a migration to initialise the `root` if it doesn't exist.

<FileName>app/schema.ts</FileName>

<CodeGroup>
```ts
import { co, z } from "jazz-tools";

export const Band = co.map({
  name: z.string(),
});

export const BandList = co.list(Band);

export const JazzFestWorkerAccount = co
  .account({
    root: co.map({
      bandList: BandList,
    }),
    profile: co.profile(),
  })
  .withMigration((account) => {
    if (!account.$jazz.has("root")) {
      account.$jazz.set("root", {
        bandList: [],
      });
      account.root?.$jazz.owner.makePublic();
    }
  });
```
</CodeGroup>

<Alert variant="info" className="mt-4 flex gap-2 items-center">
  If you're continuing from the [front-end Quickstart](/docs/getting-started/quickstart), you can extend your existing schema.
</Alert>

## Create a Server Worker

Jazz provides a CLI to create server workers. You can create a server worker using the following command:

<TabbedCodeGroup default="pnpm" savedPreferenceKey="package-manager">
<TabbedCodeGroupItem label="npm">
```sh
npx jazz-run account create --name "JazzFest Server Worker"
```
</TabbedCodeGroupItem>
<TabbedCodeGroupItem label="pnpm">
```sh
pnpx jazz-run account create --name "JazzFest Server Worker"
```
</TabbedCodeGroupItem>
</TabbedCodeGroup>

You can copy the output of this command and paste it directly into your `.env` file:

<FileName>.env</FileName>
<CodeGroup>
```bash
NEXT_PUBLIC_JAZZ_API_KEY=you@example.com
NEXT_PUBLIC_JAZZ_WORKER_ACCOUNT=co_z...
JAZZ_WORKER_SECRET=sealerSecret_z.../signerSecret_z...
```
</CodeGroup>
<Alert variant="info" className="mt-4 flex gap-2 items-center">
  If you're using Next.js, you should use the `NEXT_PUBLIC_` prefix for your public environment variables. Your `JAZZ_WORKER_SECRET` should **never** be exposed to the client.
</Alert>

## Defining your HTTP request schema

Next, we're going to set up an HTTP request schema to define our request and response. Here, we tell Jazz that we will send a `Band` under the key `band` and expect a `bandList` in response, which is a list of `Band`s. 

We also need to tell Jazz which keys should be treated as loaded in the request and response using the `resolve` query.

<FileName>app/announceBandSchema.ts</FileName>

<CodeGroup>
```ts
import { co, experimental_defineRequest } from "jazz-tools";
import { Band, BandList } from "./schema";

const workerId = process.env.NEXT_PUBLIC_JAZZ_WORKER_ACCOUNT;

if (!workerId) throw new Error("JAZZ_WORKER_ACCOUNT is not set");

export const announceBand = experimental_defineRequest({
  url: "/api/announce-band",
  workerId: workerId,
  request: { schema: { band: Band }, resolve: { band: true } },
  response: { schema: { bandList: BandList }, resolve: { bandList: true } },
});
```
</CodeGroup>

## Configure your Server Worker

We're going to use the `startWorker` function to start our server worker, and register a `POST` handler, which will listen for the requests being sent to our server worker.

We'll also use a `resolve` query here to make sure that the `bandList` is loaded on the worker's root.

<FileName>app/api/announce-band/route.ts</FileName>
<CodeGroup>
```ts
import { startWorker } from "jazz-tools/worker";
import { announceBand } from "@/app/announceBandSchema";
import { JazzFestWorkerAccount } from "@/app/schema";

export const { worker } = await startWorker({
  syncServer: `wss://cloud.jazz.tools/?key=${process.env.NEXT_PUBLIC_JAZZ_API_KEY}`,
  accountID: process.env.NEXT_PUBLIC_JAZZ_WORKER_ACCOUNT,
  accountSecret: process.env.JAZZ_WORKER_SECRET,
  AccountSchema: JazzFestWorkerAccount,
});

export async function POST(request: Request) {
  return announceBand.handle(request, worker, async ({ band }) => {
    if (!band) {
      throw new Error("Band is required");
    }
    const {
      root: { bandList },
    } = await worker.$jazz.ensureLoaded({
      resolve: {
        root: {
          bandList: true,
        },
      },
    });
    bandList.$jazz.push(band);
    return { bandList: worker.root.bandList };
  });
}
```
</CodeGroup>

## Start your server worker

We can now start our development server to make sure everything is working.

<TabbedCodeGroup default="pnpm" savedPreferenceKey="package-manager">
<TabbedCodeGroupItem label="npm">
```sh
npm run dev
```
</TabbedCodeGroupItem>
<TabbedCodeGroupItem label="pnpm">
```sh
pnpm run dev
```
</TabbedCodeGroupItem>
</TabbedCodeGroup>

If you open your browser, you should see the default Next.js welcome page.

### Not working? 
- Check you set up your `.env` file correctly
- Check you're importing `startWorker` from `jazz-tools/worker`
- Ask for help on [Discord](https://discord.gg/utDMjHYg42).

## Send requests to your server worker

### Creating a Jazz Client

We're going to wrap our Next.js app in a JazzProvider so that we can use Jazz on our client.

<FileName>app/layout.tsx</FileName>
<CodeGroup>
```tsx
import { JazzReactProvider } from "jazz-tools/react";

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body>
        <JazzReactProvider
          sync={{
            peer: `wss://cloud.jazz.tools/?key=${process.env.NEXT_PUBLIC_JAZZ_API_KEY}`,
          }}
        >
          {children}
        </JazzReactProvider>
      </body>
    </html>
  );
}
```
</CodeGroup>

### Creating your page component

We're going to send a request to our server worker to announce a new band. Our worker will respond with a list of bands that we can display on our page.

<FileName>app/page.tsx</FileName>
<CodeGroup>
```tsx
"use client";
import type { co } from "jazz-tools";
import { useState } from "react";
import { announceBand } from "@/app/announceBandSchema";
import type { BandList } from "@/app/schema";

export default function Home() {
  const [bandName, setBandName] = useState("");
  const [bandList, setBandList] = useState<co.loaded<typeof BandList>>();
  const handleAnnounceBand = async () => {
    const bandListResponse = await announceBand.send({
      band: { name: bandName },
    });
    setBandName("");
    if (bandListResponse.bandList) {
      setBandList(bandListResponse.bandList);
    }
  };

  return (
    <div>
      <input
        type="text"
        value={bandName}
        onChange={(e) => setBandName(e.target.value)}
      />
      <button type="button" onClick={handleAnnounceBand}>
        Announce Band
      </button>
      <div>
        {bandList?.map(
          (band) => band && <div key={band?.$jazz.id}>{band?.name}</div>,
        )}
      </div>
    </div>
  );
}
```
</CodeGroup>

## Try it out!
Your browser should now be showing you a page with an input field and a button. If you enter a band name and click the button, your server worker will receive the request and add the band to the list!

## Next steps
- Complete the [front-end quickstart](/docs/getting-started/quickstart) to learn more about how to use Jazz on the client
- Learn more about [error handling](/docs/server-side/http-requests#error-handling)
- Learn how to share and [collaborate on data](/docs/groups/intro) with complex permissions
